<!DOCTYPE html>
<html>
<head>
  <title>Contador de Interacciones</title>
  <%= csrf_meta_tags %>
  
  <!-- Cargar reCAPTCHA de Google -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  
  <!-- Fuente Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    /* Reset y configuraci√≥n base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #0a1929;
      color: #e6edf3;
      line-height: 1.6;
      padding: 20px;
    }
    
    /* Contenedor principal */
    .container {
      width: 100%;
      max-width: 500px;
      background-color: #132f4c;
      border-radius: 12px;
      padding: 32px;
      border: 1px solid #1e4976;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    /* Encabezado */
    .header {
      text-align: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 1px solid #1e4976;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 8px;
    }
    
    .header p {
      font-size: 15px;
      color: #8b949e;
      font-weight: 400;
    }
    
    /* Panel de estad√≠sticas */
    .stats-panel {
      background-color: #0a1929;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid #1e4976;
    }
    
    .stats-label {
      font-size: 14px;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .stats-value {
      font-size: 36px;
      font-weight: 600;
      color: #58a6ff;
      font-variant-numeric: tabular-nums;
    }
    
    /* Contenedor de reCAPTCHA */
    .recaptcha-container {
      margin: 24px 0;
      display: flex;
      justify-content: center;
    }
    
    .recaptcha-note {
      font-size: 13px;
      color: #8b949e;
      text-align: center;
      margin-bottom: 24px;
      font-style: italic;
    }
    
    /* Contenedor de botones */
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 32px;
    }
    
    /* Estilos base de botones */
    .button {
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
    }
    
    .button:hover {
      transform: translateY(-1px);
    }
    
    .button:active {
      transform: translateY(0);
    }
    
    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .button:disabled:hover {
      transform: none;
    }
    
    /* Bot√≥n primario */
    .button-primary {
      background-color: #1f6feb;
      color: #ffffff;
      border: 1px solid #388bfd;
    }
    
    .button-primary:hover:not(:disabled) {
      background-color: #2b81fb;
      border-color: #58a6ff;
      box-shadow: 0 4px 12px rgba(31, 111, 235, 0.2);
    }
    
    /* Bot√≥n secundario */
    .button-secondary {
      background-color: #21262d;
      color: #c9d1d9;
      border: 1px solid #30363d;
    }
    
    .button-secondary:hover:not(:disabled) {
      background-color: #30363d;
      border-color: #8b949e;
      box-shadow: 0 4px 12px rgba(33, 38, 45, 0.2);
    }
    
    /* Panel de mensajes */
    .message-panel {
      min-height: 48px;
      padding: 14px 16px;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      border: 1px solid transparent;
    }
    
    .message-panel:empty {
      display: none;
    }
    
    .message-info {
      background-color: #0c2d6b;
      color: #79c0ff;
      border-color: #1f6feb;
    }
    
    .message-success {
      background-color: #033a16;
      color: #7ee787;
      border-color: #238636;
    }
    
    .message-error {
      background-color: #67060c;
      color: #ff7b72;
      border-color: #da3633;
    }
    
    /* Footer */
    .footer {
      margin-top: 32px;
      text-align: center;
      font-size: 13px;
      color: #6e7681;
      padding-top: 20px;
      border-top: 1px solid #1e4976;
    }
    
    .footer span {
      display: inline-block;
      margin: 0 8px;
    }
    
    /* Iconos */
    .icon {
      font-size: 18px;
    }
    
    /* Responsive */
    @media (max-width: 480px) {
      .container {
        padding: 24px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .stats-value {
        font-size: 32px;
      }
      
      .button {
        padding: 14px 20px;
      }
    }
    
    /* Animaci√≥n sutil para el contador */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .counter-updated {
      animation: pulse 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Encabezado -->
    <div class="header">
      <h1>Contador de Interacciones</h1>
      <p>Sistema de registro en base de datos SQLite</p>
    </div>
    
    <!-- Panel de estad√≠sticas -->
    <div class="stats-panel">
      <div class="stats-label">Total de registros</div>
      <div class="stats-value" id="clickCount"><%= @total_clicks %></div>
    </div>
    
    <!-- Widget de reCAPTCHA -->
    <div class="recaptcha-container">
      <div class="g-recaptcha" 
           data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"
           data-callback="onRecaptchaSuccess"
           data-expired-callback="onRecaptchaExpired"
           data-error-callback="onRecaptchaError">
      </div>
    </div>
    
    <div class="recaptcha-note">
      Verifica que no eres un robot para habilitar el registro
    </div>
    
    <!-- Contenedor de botones -->
    <div class="button-container">
      <button id="clickButton" class="button button-primary" disabled>
        <span class="icon">üìä</span>
        <span id="buttonText">Verifica reCAPTCHA primero</span>
      </button>
      
      <button id="randomErrorButton" class="button button-secondary">
        <span class="icon">‚ö†Ô∏è</span>
        Simular Error
      </button>
    </div>
    
    <!-- Panel de mensajes -->
    <div id="message" class="message-panel"></div>
  </div>
  
  <!-- Footer -->
  <div class="footer">
    <span>Rails 8.1.2</span>
    ‚Ä¢
    <span>Ruby 3.2.9</span>
    ‚Ä¢
    <span>SQLite</span>
    ‚Ä¢
    <span>reCAPTCHA v2</span>
  </div>

  <script>
    // ============ CONFIGURACI√ìN INICIAL ============
    // Elementos del DOM
    const clickButton = document.getElementById('clickButton');
    const buttonText = document.getElementById('buttonText');
    const randomErrorButton = document.getElementById('randomErrorButton');
    const clickCount = document.getElementById('clickCount');
    const messageDiv = document.getElementById('message');
    
    // Estado de la aplicaci√≥n
    let isProcessing = false;
    let recaptchaVerified = false;
    
    // ============ FUNCIONES DE UTILIDAD ============
    
    // Funci√≥n para mostrar mensajes
    function showMessage(text, type = 'info') {
      messageDiv.textContent = text;
      messageDiv.className = 'message-panel';
      
      if (text) {
        messageDiv.classList.add(`message-${type}`);
      }
      
      // Auto-ocultar mensajes de √©xito despu√©s de 3 segundos
      if (type === 'success') {
        setTimeout(() => {
          if (messageDiv.textContent === text) {
            messageDiv.textContent = '';
            messageDiv.className = 'message-panel';
          }
        }, 3000);
      }
    }
    
    // Funci√≥n para actualizar el contador
    function updateCounter() {
      fetch('/clicks/total')
        .then(response => response.json())
        .then(data => {
          clickCount.textContent = data.total;
          clickCount.classList.add('counter-updated');
          
          setTimeout(() => {
            clickCount.classList.remove('counter-updated');
          }, 300);
        })
        .catch(error => {
          console.error('Error al actualizar contador:', error);
        });
    }
    
    // ============ FUNCIONES DE reCAPTCHA ============
    
    function onRecaptchaSuccess(response) {
      recaptchaVerified = true;
      
      // Habilitar el bot√≥n principal
      clickButton.disabled = false;
      buttonText.textContent = 'Registrar Interacci√≥n';
      
      // Mostrar mensaje de √©xito
      showMessage('‚úÖ Verificaci√≥n completada. Ahora puedes registrar interacciones.', 'success');
    }
    
    function onRecaptchaExpired() {
      recaptchaVerified = false;
      
      // Deshabilitar el bot√≥n principal
      clickButton.disabled = true;
      buttonText.textContent = 'Verifica reCAPTCHA primero';
      
      showMessage('‚è≥ La verificaci√≥n ha expirado. Por favor, verifica nuevamente.', 'error');
    }
    
    function onRecaptchaError() {
      showMessage('‚ùå Error en la verificaci√≥n. Por favor, recarga la p√°gina.', 'error');
    }
    
    // ============ MANEJADORES DE EVENTOS ============
    
    // Funci√≥n para manejar el registro de interacci√≥n
    async function handleClick() {
      // Validaciones
      if (!recaptchaVerified) {
        showMessage('‚ö†Ô∏è Por favor, completa la verificaci√≥n reCAPTCHA primero.', 'error');
        return;
      }
      
      if (isProcessing) return;
      
      // Configurar estado de procesamiento
      isProcessing = true;
      showMessage('‚è≥ Procesando registro...', 'info');
      clickButton.disabled = true;
      
      try {
        // Obtener el token de reCAPTCHA
        const recaptchaResponse = grecaptcha.getResponse();
        
        if (!recaptchaResponse) {
          throw new Error('Token de reCAPTCHA no disponible');
        }
        
        // Enviar solicitud al servidor
        const response = await fetch('/clicks/increment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({
            'g-recaptcha-response': recaptchaResponse
          })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Error en el servidor');
        }
        
        if (data.success) {
          // Actualizar contador
          clickCount.textContent = data.total;
          showMessage('‚úÖ ' + data.message, 'success');
          
          // Resetear reCAPTCHA para el pr√≥ximo registro
          grecaptcha.reset();
          recaptchaVerified = false;
          clickButton.disabled = true;
          buttonText.textContent = 'Verifica reCAPTCHA primero';
        } else {
          showMessage('‚ùå ' + (data.error || 'Error al procesar la solicitud'), 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('‚ùå Error de conexi√≥n. Intenta nuevamente.', 'error');
      } finally {
        // Restaurar estado
        isProcessing = false;
        if (recaptchaVerified) {
          clickButton.disabled = false;
        }
      }
    }
    
    // Funci√≥n para manejar simulaci√≥n de error
    function handleRandomError() {
      if (isProcessing) return;
      
      isProcessing = true;
      showMessage('üé≤ Generando simulaci√≥n de error...', 'info');
      randomErrorButton.disabled = true;
      
      setTimeout(() => {
        window.location.href = '/random_error';
        isProcessing = false;
        randomErrorButton.disabled = false;
      }, 800);
    }
    
    // ============ INICIALIZACI√ìN ============
    
    function initialize() {
      // Agregar event listeners
      clickButton.addEventListener('click', handleClick);
      randomErrorButton.addEventListener('click', handleRandomError);
      
      // Actualizar contador inicial
      updateCounter();
      
      // Configurar actualizaci√≥n peri√≥dica
      setInterval(updateCounter, 10000);
      
      // Mensaje de bienvenida
      setTimeout(() => {
        showMessage('üëã Completa la verificaci√≥n reCAPTCHA para habilitar el registro.', 'info');
      }, 1000);
      
      // Tecla Enter para activar el bot√≥n principal
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !isProcessing && recaptchaVerified) {
          handleClick();
        }
      });
    }
    
    // Verificar si reCAPTCHA est√° cargado antes de inicializar
    function checkRecaptchaLoaded() {
      if (typeof grecaptcha !== 'undefined') {
        initialize();
      } else {
        setTimeout(checkRecaptchaLoaded, 100);
      }
    }
    
    // Iniciar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkRecaptchaLoaded);
    } else {
      checkRecaptchaLoaded();
    }
  </script>
</body>
</html>