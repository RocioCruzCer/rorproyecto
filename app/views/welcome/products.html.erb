<%# app/views/welcome/products.html.erb - VERSIÓN COMPLETA Y CORREGIDA %>

<% content_for :head do %>
  <style>
    :root {
      --verde-primario: #00A86B;
      --verde-oscuro: #008F4C;
      --verde-profundo: #0B5D3B;
      --rosa-clarito: #FFB6C1;
      --rosa-suave: #FFC0CB;
      --rosa-muy-palido: #FFF0F5;
      --casi-negro: #2F2F2A;
      --gris-medio: #5C5C55;
      --verde-muy-claro: #F0F7F3;
      --blanco: #FFFFFF;
      --sombra-rosa-claro: rgba(255, 182, 193, 0.3);
    }

    body {
      background-color: var(--verde-muy-claro);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
    }

    .products-page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }

    /* Header */
    .page-header {
      margin-bottom: 30px;
    }

    .page-header h1 {
      color: var(--verde-profundo);
      font-size: 32px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
    }

    .page-header h1 i {
      color: var(--rosa-clarito);
      font-size: 36px;
      background: var(--rosa-muy-palido);
      padding: 10px;
      border-radius: 16px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--blanco);
      padding: 20px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 4px 12px var(--sombra-rosa-claro);
      border: 1px solid rgba(255, 182, 193, 0.2);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-3px);
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--rosa-clarito), var(--rosa-suave));
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }

    .stat-info h3 {
      font-size: 24px;
      font-weight: 700;
      color: var(--verde-profundo);
      margin: 0 0 5px 0;
    }

    .stat-info p {
      color: var(--gris-medio);
      margin: 0;
      font-size: 14px;
    }

    /* Formulario */
    .form-container {
      background: var(--blanco);
      border-radius: 30px;
      padding: 30px;
      margin-bottom: 40px;
      box-shadow: 0 10px 30px var(--sombra-rosa-claro);
      border: 1px solid rgba(255, 182, 193, 0.3);
    }

    .form-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 25px;
    }

    .form-title h2 {
      color: var(--verde-profundo);
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    }

    .form-title i {
      color: var(--rosa-clarito);
      font-size: 28px;
    }

    .products-form {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    .form-group {
      margin-bottom: 0;
    }

    .form-group label {
      color: var(--verde-profundo);
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .form-group label i {
      color: var(--rosa-clarito);
    }

    .form-group .required {
      color: #dc3545;
      margin-left: 3px;
    }

    .form-control, .form-select {
      border: 2px solid rgba(255, 182, 193, 0.3);
      border-radius: 12px;
      padding: 12px 15px;
      font-size: 14px;
      transition: all 0.3s ease;
      width: 100%;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--rosa-clarito);
      box-shadow: 0 0 0 4px var(--sombra-rosa-claro);
      outline: none;
    }

    .form-control.is-invalid {
      border-color: #dc3545;
    }

    .invalid-feedback {
      color: #dc3545;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }

    .btn-submit {
      background: linear-gradient(135deg, var(--verde-primario), var(--verde-oscuro));
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 30px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      grid-column: span 4;
      justify-self: start;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 168, 107, 0.3);
    }

    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Buscador */
    .search-section {
      margin-bottom: 20px;
    }

    .search-container {
      display: flex;
      gap: 15px;
      align-items: center;
      background: var(--blanco);
      padding: 15px 20px;
      border-radius: 50px;
      border: 1px solid rgba(255, 182, 193, 0.3);
      box-shadow: 0 4px 12px var(--sombra-rosa-claro);
    }

    .search-icon {
      color: var(--rosa-clarito);
      font-size: 20px;
    }

    .search-input {
      flex: 1;
      border: none;
      padding: 8px 0;
      font-size: 15px;
      background: transparent;
    }

    .search-input:focus {
      outline: none;
    }

    .search-clear {
      background: none;
      border: none;
      color: var(--gris-medio);
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 20px;
      transition: all 0.3s ease;
    }

    .search-clear:hover {
      background: var(--rosa-muy-palido);
      color: var(--rosa-clarito);
    }

    /* Tabla de productos */
    .table-container {
      background: var(--blanco);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px var(--sombra-rosa-claro);
      border: 1px solid rgba(255, 182, 193, 0.3);
      margin-bottom: 20px;
    }

    .table {
      width: 100%;
      margin-bottom: 0;
      border-collapse: collapse;
    }

    .table thead th {
      background: linear-gradient(135deg, var(--rosa-muy-palido), var(--blanco));
      color: var(--verde-profundo);
      font-weight: 600;
      border-bottom: 2px solid var(--rosa-clarito);
      padding: 15px;
      text-align: left;
    }

    .table tbody td {
      padding: 15px;
      vertical-align: middle;
      border-bottom: 1px solid rgba(255, 182, 193, 0.2);
    }

    .price-badge {
      background: linear-gradient(135deg, var(--verde-primario), var(--verde-oscuro));
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 13px;
      display: inline-block;
    }

    .category-badge {
      background: var(--rosa-muy-palido);
      color: var(--verde-profundo);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 13px;
      display: inline-block;
    }

    .brand-badge {
      background: var(--verde-muy-claro);
      color: var(--verde-profundo);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 13px;
      display: inline-block;
    }

    /* Acciones */
    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-action {
      width: 35px;
      height: 35px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-edit {
      background: var(--verde-muy-claro);
      color: var(--verde-profundo);
    }

    .btn-edit:hover {
      background: var(--verde-primario);
      color: white;
    }

    .btn-delete {
      background: var(--rosa-muy-palido);
      color: var(--rosa-clarito);
    }

    .btn-delete:hover {
      background: var(--rosa-clarito);
      color: white;
    }

    /* Paginación */
    .pagination-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}

.pagination {
  display: flex;
  gap: 5px;
  list-style: none;
  padding: 0;
  margin: 0;
  flex-wrap: wrap;
  justify-content: center;
}

.page-link {
  border: 1px solid rgba(255, 182, 193, 0.3);
  color: var(--verde-profundo);
  border-radius: 10px;
  padding: 8px 15px;
  transition: all 0.3s ease;
  text-decoration: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  background: white;
  font-size: 14px;
}

    .page-link i {
  font-size: 12px;
}

.page-link:hover {
  background: var(--rosa-muy-palido);
  border-color: var(--rosa-clarito);
  transform: translateY(-2px);
}

.page-item.active .page-link {
  background: linear-gradient(135deg, var(--rosa-clarito), var(--rosa-suave));
  border-color: var(--rosa-clarito);
  color: var(--verde-profundo);
  font-weight: 600;
}

.page-item.disabled .page-link {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
  background: #f8f9fa;
}

.pagination-info {
  margin-top: 15px;
  padding: 8px 16px;
  background: var(--rosa-muy-palido);
  border-radius: 20px;
  display: inline-block;
}

/* Responsive para la paginación */
@media (max-width: 768px) {
  .pagination {
    gap: 3px;
  }
  
  .page-link {
    padding: 6px 10px;
    font-size: 12px;
  }
  
  .page-link i {
    font-size: 10px;
  }
  
  .pagination-info {
    font-size: 12px;
    padding: 6px 12px;
  }
}

@media (max-width: 576px) {
  .page-link span {
    display: none; /* Oculta el texto "Primero", "Anterior", etc. en móviles */
  }
  
  .page-link i {
    font-size: 14px;
  }
  
  .page-link {
    padding: 8px 12px;
  }
}

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-dialog {
      width: 90%;
      max-width: 500px;
      margin: 0 auto;
    }

    .modal-content {
      background: var(--blanco);
      border: none;
      border-radius: 30px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      background: linear-gradient(135deg, var(--rosa-clarito), var(--rosa-suave));
      border-bottom: none;
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header .modal-title {
      color: var(--verde-profundo);
      font-weight: 600;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
    }

    .modal-header.bg-danger {
      background: linear-gradient(135deg, #dc3545, #bb2d3b) !important;
    }

    .modal-header.bg-danger .modal-title {
      color: white;
    }

    .btn-close {
      background: transparent;
      border: none;
      color: var(--verde-profundo);
      font-size: 24px;
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .btn-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .modal-body {
      padding: 25px;
    }

    .modal-footer {
      border-top: 1px solid rgba(255, 182, 193, 0.3);
      padding: 20px 25px;
      background: var(--rosa-muy-palido);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-outline-secondary {
      background: transparent;
      border: 1px solid var(--gris-medio);
      color: var(--gris-medio);
    }

    .btn-outline-secondary:hover {
      background: var(--gris-medio);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--verde-primario), var(--verde-oscuro));
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 168, 107, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc3545, #bb2d3b);
      color: white;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }

    /* Alertas */
    .alert {
      border-radius: 12px;
      padding: 15px 20px;
      margin-top: 20px;
      position: relative;
    }

    .alert-success {
      background: linear-gradient(135deg, var(--verde-muy-claro), var(--blanco));
      border: 1px solid var(--verde-primario);
      color: var(--verde-profundo);
    }

    .alert-danger {
      background: linear-gradient(135deg, #f8d7da, #fff);
      border: 1px solid #dc3545;
      color: #721c24;
    }

    .btn-close-alert {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: inherit;
    }

    /* Responsive */
    @media (max-width: 992px) {
      .products-form {
        grid-template-columns: repeat(2, 1fr);
      }
      .btn-submit {
        grid-column: span 2;
      }
    }

    @media (max-width: 768px) {
      .products-page {
        padding: 15px;
      }
      .products-form {
        grid-template-columns: 1fr;
      }
      .btn-submit {
        grid-column: span 1;
        width: 100%;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .table thead {
        display: none;
      }
      .table tbody tr {
        display: block;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 182, 193, 0.3);
        border-radius: 15px;
      }
      .table tbody td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid rgba(255, 182, 193, 0.1);
      }
      .table tbody td:last-child {
        border-bottom: none;
      }
      .table tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--verde-profundo);
        margin-right: 15px;
      }
    }
  </style>
<% end %>

<div class="products-page">
  <!-- Header -->
  <div class="page-header">
    <h1>
      <i class="bi bi-box-seam"></i>
      Gestión de Productos
    </h1>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">
        <i class="bi bi-box"></i>
      </div>
      <div class="stat-info">
        <h3 id="totalProducts"><%= Product.count %></h3>
        <p>Total productos</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">
        <i class="bi bi-tags"></i>
      </div>
      <div class="stat-info">
        <h3 id="totalCategories"><%= Product.distinct.count(:category) %></h3>
        <p>Categorías</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">
        <i class="bi bi-building"></i>
      </div>
      <div class="stat-info">
        <h3 id="totalBrands"><%= Product.distinct.count(:brand) %></h3>
        <p>Marcas</p>
      </div>
    </div>
  </div>

  <!-- Formulario -->
  <div class="form-container">
    <div class="form-title">
      <i class="bi bi-plus-circle"></i>
      <h2>Registrar Nuevo Producto</h2>
    </div>

    <form id="productForm" class="products-form">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      
      <div class="form-group">
        <label for="product_name">
          <i class="bi bi-card-heading"></i>
          Nombre <span class="required">*</span>
        </label>
        <input type="text" id="product_name" name="product[name]" class="form-control" placeholder="Ej: Smartphone Galaxy S23" required>
        <div class="invalid-feedback" id="name-error"></div>
      </div>

      <div class="form-group">
        <label for="product_category">
          <i class="bi bi-grid"></i>
          Categoría <span class="required">*</span>
        </label>
        <select id="product_category" name="product[category]" class="form-select" required>
          <option value="">Selecciona una categoría</option>
          <% if defined?(Product::CATEGORIES) %>
            <% Product::CATEGORIES.each do |cat| %>
              <option value="<%= cat %>"><%= cat %></option>
            <% end %>
          <% else %>
            <option value="Electrónica">Electrónica</option>
            <option value="Ropa y Accesorios">Ropa y Accesorios</option>
            <option value="Hogar y Muebles">Hogar y Muebles</option>
            <option value="Deportes">Deportes</option>
            <option value="Juguetes">Juguetes</option>
            <option value="Libros">Libros</option>
            <option value="Alimentos y Bebidas">Alimentos y Bebidas</option>
            <option value="Belleza y Cuidado Personal">Belleza y Cuidado Personal</option>
            <option value="Automotriz">Automotriz</option>
            <option value="Mascotas">Mascotas</option>
          <% end %>
        </select>
        <div class="invalid-feedback" id="category-error"></div>
      </div>

      <div class="form-group">
        <label for="product_price">
          <i class="bi bi-currency-dollar"></i>
          Precio <span class="required">*</span>
        </label>
        <input type="number" id="product_price" name="product[price]" class="form-control" placeholder="0.00" step="0.01" min="0" required>
        <div class="invalid-feedback" id="price-error"></div>
      </div>

      <div class="form-group">
        <label for="product_brand">
          <i class="bi bi-building"></i>
          Marca <span class="required">*</span>
        </label>
        <select id="product_brand" name="product[brand]" class="form-select" required>
          <option value="">Selecciona una marca</option>
          <% if defined?(Product::BRANDS) %>
            <% Product::BRANDS.each do |brand| %>
              <option value="<%= brand %>"><%= brand %></option>
            <% end %>
          <% else %>
            <option value="Samsung">Samsung</option>
            <option value="Apple">Apple</option>
            <option value="Sony">Sony</option>
            <option value="LG">LG</option>
            <option value="Nike">Nike</option>
            <option value="Adidas">Adidas</option>
            <option value="Microsoft">Microsoft</option>
            <option value="Xiaomi">Xiaomi</option>
            <option value="HP">HP</option>
            <option value="Dell">Dell</option>
            <option value="Lenovo">Lenovo</option>
            <option value="Otros">Otros</option>
          <% end %>
        </select>
        <div class="invalid-feedback" id="brand-error"></div>
      </div>

      <button type="submit" class="btn-submit" id="submitBtn">
        <i class="bi bi-check-circle"></i> Guardar Producto
      </button>
    </form>
    <div id="formMessage"></div>
  </div>

  <!-- Buscador -->
  <div class="search-section">
    <div class="search-container">
      <i class="bi bi-search search-icon"></i>
      <input type="text" id="searchInput" class="search-input" placeholder="Buscar por nombre, categoría o marca...">
      <button id="clearSearch" class="search-clear" style="display: none;">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>

  <!-- Tabla de productos -->
  <div class="table-container">
    <div id="productsTableContainer">
      <% if @products && @products.any? %>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Nombre</th>
                <th>Categoría</th>
                <th>Precio</th>
                <th>Marca</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <% @products.each_with_index do |product, index| %>
                <tr>
                  <td data-label="#">#<%= ((@products.current_page - 1) * 15) + index + 1 %></td>
                  <td data-label="Nombre"><strong><%= product.name %></strong></td>
                  <td data-label="Categoría">
                    <span class="category-badge"><i class="bi bi-tag"></i> <%= product.category %></span>
                  </td>
                  <td data-label="Precio">
                    <span class="price-badge"><i class="bi bi-currency-dollar"></i> $<%= number_with_delimiter(product.price) %></span>
                  </td>
                  <td data-label="Marca">
                    <span class="brand-badge"><i class="bi bi-building"></i> <%= product.brand %></span>
                  </td>
                  <td data-label="Fecha">
                    <small class="text-muted"><i class="bi bi-calendar3"></i> <%= product.created_at.strftime("%d/%m/%Y") %></small>
                  </td>
                  <td data-label="Acciones">
                    <div class="action-buttons">
                      <button type="button" class="btn-action btn-edit" onclick='editProduct(<%= product.id %>, <%= product.name.to_json %>, <%= product.category.to_json %>, <%= product.price %>, <%= product.brand.to_json %>)'>
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button type="button" class="btn-action btn-delete" onclick='confirmDelete(<%= product.id %>, <%= product.name.to_json %>)'>
                        <i class="bi bi-trash3"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <% if @products.total_pages > 1 %>
          <div class="pagination-container">
            <nav>
              <ul class="pagination">
                <% if @products.prev_page %>
                  <li class="page-item"><a href="?page=<%= @products.prev_page %>" class="page-link">Anterior</a></li>
                <% else %>
                  <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                <% end %>

                <% (1..@products.total_pages).each do |page| %>
                  <li class="page-item <%= 'active' if page == @products.current_page %>">
                    <a href="?page=<%= page %>" class="page-link"><%= page %></a>
                  </li>
                <% end %>

                <% if @products.next_page %>
                  <li class="page-item"><a href="?page=<%= @products.next_page %>" class="page-link">Siguiente</a></li>
                <% else %>
                  <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
                <% end %>
              </ul>
            </nav>
          </div>
        <% end %>
      <% else %>
        <div class="text-center py-5">
          <i class="bi bi-inbox" style="font-size: 60px; color: var(--rosa-clarito);"></i>
          <h4 class="mt-3 text-muted">No hay productos registrados</h4>
          <p class="text-muted">Comienza agregando tu primer producto</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Modal de edición -->
<div class="modal" id="editModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Editar Producto</h5>
        <button type="button" class="btn-close" onclick="closeModal('editModal')">×</button>
      </div>
      <form id="editForm">
        <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
        <div class="modal-body">
          <div class="mb-3">
            <label for="edit_name" class="form-label">Nombre</label>
            <input type="text" class="form-control" id="edit_name" name="product[name]" required>
          </div>
          <div class="mb-3">
            <label for="edit_category" class="form-label">Categoría</label>
            <select class="form-select" id="edit_category" name="product[category]" required>
              <option value="">Selecciona una categoría</option>
              <% if defined?(Product::CATEGORIES) %>
                <% Product::CATEGORIES.each do |cat| %>
                  <option value="<%= cat %>"><%= cat %></option>
                <% end %>
              <% else %>
                <option value="Electrónica">Electrónica</option>
                <option value="Ropa y Accesorios">Ropa y Accesorios</option>
                <option value="Hogar y Muebles">Hogar y Muebles</option>
                <option value="Deportes">Deportes</option>
                <option value="Juguetes">Juguetes</option>
                <option value="Libros">Libros</option>
                <option value="Alimentos y Bebidas">Alimentos y Bebidas</option>
                <option value="Belleza y Cuidado Personal">Belleza y Cuidado Personal</option>
                <option value="Automotriz">Automotriz</option>
                <option value="Mascotas">Mascotas</option>
              <% end %>
            </select>
          </div>
          <div class="mb-3">
            <label for="edit_price" class="form-label">Precio</label>
            <input type="number" class="form-control" id="edit_price" name="product[price]" step="0.01" min="0" required>
          </div>
          <div class="mb-3">
            <label for="edit_brand" class="form-label">Marca</label>
            <select class="form-select" id="edit_brand" name="product[brand]" required>
              <option value="">Selecciona una marca</option>
              <% if defined?(Product::BRANDS) %>
                <% Product::BRANDS.each do |brand| %>
                  <option value="<%= brand %>"><%= brand %></option>
                <% end %>
              <% else %>
                <option value="Samsung">Samsung</option>
                <option value="Apple">Apple</option>
                <option value="Sony">Sony</option>
                <option value="LG">LG</option>
                <option value="Nike">Nike</option>
                <option value="Adidas">Adidas</option>
                <option value="Microsoft">Microsoft</option>
                <option value="Xiaomi">Xiaomi</option>
                <option value="HP">HP</option>
                <option value="Dell">Dell</option>
                <option value="Lenovo">Lenovo</option>
                <option value="Otros">Otros</option>
              <% end %>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" onclick="closeModal('editModal')">Cancelar</button>
          <button type="submit" class="btn btn-success">Actualizar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de eliminación -->
<div class="modal" id="deleteModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger">
        <h5 class="modal-title text-white"><i class="bi bi-exclamation-triangle"></i> Confirmar eliminación</h5>
        <button type="button" class="btn-close text-white" onclick="closeModal('deleteModal')">×</button>
      </div>
      <div class="modal-body text-center py-4">
        <i class="bi bi-trash3" style="font-size: 48px; color: #dc3545;"></i>
        <h4 class="mt-3">¿Estás seguro?</h4>
        <p>Esta acción no se puede deshacer.</p>
        <p class="fw-bold" id="deleteProductName"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" onclick="closeModal('deleteModal')">Cancelar</button>
        <form id="deleteForm" style="display: inline;">
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          <button type="submit" class="btn btn-danger"><i class="bi bi-trash3"></i> Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // ========== VARIABLES GLOBALES ==========
  let currentEditId = null;
  let currentDeleteId = null;

  // ========== FUNCIONES PARA MODALES ==========
  function openModal(modalId) {
    document.getElementById(modalId).classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
    document.body.style.overflow = '';
  }

  // Cerrar modal al hacer clic fuera
  window.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
      event.target.classList.remove('show');
      document.body.style.overflow = '';
    }
  });

  // ========== FUNCIONES PARA PRODUCTOS ==========
  window.editProduct = function(id, name, category, price, brand) {
    currentEditId = id;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_category').value = category;
    document.getElementById('edit_price').value = price;
    document.getElementById('edit_brand').value = brand;
    openModal('editModal');
  }

  window.confirmDelete = function(id, name) {
    currentDeleteId = id;
    document.getElementById('deleteProductName').textContent = `"${name}"`;
    openModal('deleteModal');
  }

  // ========== INICIALIZACIÓN ==========
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('productForm');
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    let searchTimeout;

    // ========== ENVÍO DEL FORMULARIO PRINCIPAL ==========
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        clearErrors();
        
        if (!validateForm()) {
          return;
        }
        
        const formData = new FormData(this);
        const csrfToken = document.querySelector('input[name="authenticity_token"]').value;
        
        setLoadingState(true);
        
        try {
          const response = await fetch('/products', {
            method: 'POST',
            headers: {
              'X-CSRF-Token': csrfToken,
              'Accept': 'application/json'
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            if (result.html) {
              document.getElementById('productsTableContainer').innerHTML = result.html;
            }
            form.reset();
            showMessage('success', '✅ Producto guardado exitosamente');
            updateStats();
          } else {
            if (result.errors && result.errors.length > 0) {
              displayServerErrors(result.errors);
            } else {
              showMessage('danger', '❌ Error al guardar el producto');
            }
          }
        } catch (error) {
          console.error('Error:', error);
          showMessage('danger', '❌ Error de conexión con el servidor');
        } finally {
          setLoadingState(false);
        }
      });
    }

    // ========== ENVÍO DEL FORMULARIO DE EDICIÓN ==========
    const editForm = document.getElementById('editForm');
    if (editForm) {
      editForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        // Agregar _method para que Rails lo interprete como PATCH
        formData.append('_method', 'patch');
        
        const csrfToken = document.querySelector('input[name="authenticity_token"]').value;
        
        try {
          const response = await fetch(`/products/${currentEditId}`, {
            method: 'POST', // Usamos POST pero con _method=patch
            headers: {
              'X-CSRF-Token': csrfToken,
              'Accept': 'application/json'
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            closeModal('editModal');
            if (result.html) {
              document.getElementById('productsTableContainer').innerHTML = result.html;
            }
            showMessage('success', '✅ Producto actualizado exitosamente');
            updateStats();
          } else {
            alert('Error al actualizar: ' + (result.errors || 'Error desconocido').join(', '));
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error de conexión');
        }
      });
    }

    // ========== ENVÍO DEL FORMULARIO DE ELIMINACIÓN ==========
    const deleteForm = document.getElementById('deleteForm');
    if (deleteForm) {
      deleteForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        // Agregar _method para que Rails lo interprete como DELETE
        formData.append('_method', 'delete');
        
        const csrfToken = document.querySelector('input[name="authenticity_token"]').value;
        
        try {
          const response = await fetch(`/products/${currentDeleteId}`, {
            method: 'POST', // Usamos POST pero con _method=delete
            headers: {
              'X-CSRF-Token': csrfToken,
              'Accept': 'application/json'
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            closeModal('deleteModal');
            if (result.html) {
              document.getElementById('productsTableContainer').innerHTML = result.html;
            }
            showMessage('success', '✅ Producto eliminado exitosamente');
            updateStats();
          } else {
            alert('Error al eliminar');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error de conexión');
        }
      });
    }

    // ========== BÚSQUEDA EN TIEMPO REAL ==========
// ========== BÚSQUEDA EN EL CLIENTE (SIN CONSULTAS AL SERVIDOR) ==========
if (searchInput) {
  searchInput.addEventListener('input', function() {
    const query = this.value.trim().toLowerCase();
    
    // Mostrar/ocultar botón de limpiar
    clearSearch.style.display = query.length > 0 ? 'block' : 'none';
    
    // Obtener todas las filas de la tabla
    const tableBody = document.querySelector('#productsTableContainer table tbody');
    if (!tableBody) return; // Si no hay tabla, salir
    
    const tableRows = tableBody.querySelectorAll('tr');
    let visibleCount = 0;
    
    tableRows.forEach(row => {
      // Obtener el texto de las celdas que queremos buscar
      const nombreCell = row.querySelector('td[data-label="Nombre"]');
      const categoriaCell = row.querySelector('td[data-label="Categoría"]');
      const marcaCell = row.querySelector('td[data-label="Marca"]');
      
      const nombre = nombreCell ? nombreCell.textContent.toLowerCase() : '';
      const categoria = categoriaCell ? categoriaCell.textContent.toLowerCase() : '';
      const marca = marcaCell ? marcaCell.textContent.toLowerCase() : '';
      
      // Si el query está vacío, mostrar todas las filas
      if (query.length === 0) {
        row.style.display = '';
        visibleCount++;
      } else {
        // Buscar en nombre, categoría y marca
        if (nombre.includes(query) || categoria.includes(query) || marca.includes(query)) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      }
    });
    
    // Manejar el mensaje de "no resultados"
    const tableContainer = document.getElementById('productsTableContainer');
    let noResultsMsg = document.getElementById('noResultsMessage');
    
    if (visibleCount === 0 && query.length > 0) {
      // Ocultar la tabla si no hay resultados
      const table = document.querySelector('#productsTableContainer table');
      if (table) table.style.display = 'none';
      
      // Mostrar mensaje de no resultados
      if (!noResultsMsg) {
        noResultsMsg = document.createElement('div');
        noResultsMsg.id = 'noResultsMessage';
        noResultsMsg.className = 'text-center py-5';
        noResultsMsg.innerHTML = `
          <i class="bi bi-search" style="font-size: 60px; color: var(--rosa-clarito);"></i>
          <h4 class="mt-3 text-muted">No se encontraron productos</h4>
          <p class="text-muted">No hay resultados para "<strong>${this.value}</strong>"</p>
        `;
        tableContainer.appendChild(noResultsMsg);
      } else {
        noResultsMsg.querySelector('p').innerHTML = `No hay resultados para "<strong>${this.value}</strong>"`;
      }
    } else {
      // Mostrar la tabla si hay resultados
      const table = document.querySelector('#productsTableContainer table');
      if (table) table.style.display = '';
      
      // Eliminar mensaje de no resultados si existe
      if (noResultsMsg) {
        noResultsMsg.remove();
      }
    }
  });
}

// Limpiar búsqueda
if (clearSearch) {
  clearSearch.addEventListener('click', function() {
    searchInput.value = '';
    clearSearch.style.display = 'none';
    
    // Mostrar todas las filas
    const tableRows = document.querySelectorAll('#productsTableContainer table tbody tr');
    tableRows.forEach(row => {
      row.style.display = '';
    });
    
    // Mostrar la tabla
    const table = document.querySelector('#productsTableContainer table');
    if (table) table.style.display = '';
    
    // Eliminar mensaje de no resultados
    const noResultsMsg = document.getElementById('noResultsMessage');
    if (noResultsMsg) {
      noResultsMsg.remove();
    }
  });
}

    // ========== PAGINACIÓN CON AJAX ==========
    document.addEventListener('click', function(e) {
      const pageLink = e.target.closest('.page-link[data-remote="true"]');
      if (pageLink && !pageLink.closest('.disabled')) {
        e.preventDefault();
        const url = pageLink.getAttribute('href');
        
        if (url) {
          fetch(url, {
            headers: { 'Accept': 'text/html' }
          })
          .then(response => response.text())
          .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newContainer = doc.getElementById('productsTableContainer');
            
            if (newContainer) {
              document.getElementById('productsTableContainer').innerHTML = newContainer.innerHTML;
            }
            
            window.history.pushState({}, '', url);
          })
          .catch(error => console.error('Error en paginación:', error));
        }
      }
    });
  });

  // ========== FUNCIONES DE VALIDACIÓN ==========
  function validateForm() {
    let isValid = true;
    const name = document.getElementById('product_name');
    const category = document.getElementById('product_category');
    const price = document.getElementById('product_price');
    const brand = document.getElementById('product_brand');
    
    if (!name.value.trim()) {
      showFieldError('name', 'El nombre es obligatorio');
      isValid = false;
    } else if (name.value.trim().length < 3) {
      showFieldError('name', 'El nombre debe tener al menos 3 caracteres');
      isValid = false;
    } else {
      clearFieldError('name');
    }
    
    if (!category.value) {
      showFieldError('category', 'La categoría es obligatoria');
      isValid = false;
    } else {
      clearFieldError('category');
    }
    
    if (!price.value) {
      showFieldError('price', 'El precio es obligatorio');
      isValid = false;
    } else if (parseFloat(price.value) <= 0) {
      showFieldError('price', 'El precio debe ser mayor a 0');
      isValid = false;
    } else {
      clearFieldError('price');
    }
    
    if (!brand.value) {
      showFieldError('brand', 'La marca es obligatoria');
      isValid = false;
    } else {
      clearFieldError('brand');
    }
    
    return isValid;
  }

  function showFieldError(field, message) {
    const input = document.getElementById(`product_${field}`);
    const errorDiv = document.getElementById(`${field}-error`);
    
    if (input && errorDiv) {
      input.classList.add('is-invalid');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }
  }

  function clearFieldError(field) {
    const input = document.getElementById(`product_${field}`);
    const errorDiv = document.getElementById(`${field}-error`);
    
    if (input && errorDiv) {
      input.classList.remove('is-invalid');
      errorDiv.style.display = 'none';
    }
  }

  function clearErrors() {
    document.querySelectorAll('.is-invalid').forEach(el => {
      el.classList.remove('is-invalid');
    });
    
    document.querySelectorAll('.invalid-feedback').forEach(el => {
      el.style.display = 'none';
    });
  }

  function displayServerErrors(errors) {
    errors.forEach(error => {
      const errorLower = error.toLowerCase();
      if (errorLower.includes('nombre')) {
        showFieldError('name', error);
      } else if (errorLower.includes('categor')) {
        showFieldError('category', error);
      } else if (errorLower.includes('precio')) {
        showFieldError('price', error);
      } else if (errorLower.includes('marca')) {
        showFieldError('brand', error);
      } else {
        showMessage('danger', `❌ ${error}`);
      }
    });
  }

  // ========== ESTADO DE CARGA ==========
  function setLoadingState(isLoading) {
    const submitBtn = document.getElementById('submitBtn');
    if (isLoading) {
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';
      submitBtn.disabled = true;
    } else {
      submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Guardar Producto';
      submitBtn.disabled = false;
    }
  }

  // ========== MOSTRAR MENSAJES ==========
  function showMessage(type, text) {
    const oldMessage = document.querySelector('.alert');
    if (oldMessage) {
      oldMessage.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.innerHTML = `
      ${text}
      <button type="button" class="btn-close-alert" onclick="this.parentElement.remove()">×</button>
    `;
    
    document.getElementById('formMessage').appendChild(messageDiv);
    
    setTimeout(() => {
      if (messageDiv.parentElement) {
        messageDiv.remove();
      }
    }, 5000);
  }

  // ========== ACTUALIZAR ESTADÍSTICAS ==========
  function updateStats() {
    setTimeout(() => {
      fetch('/product_data')
        .then(response => response.json())
        .then(data => {
          document.getElementById('totalProducts').textContent = data.length;
          
          const categories = new Set(data.map(p => p.category));
          document.getElementById('totalCategories').textContent = categories.size;
          
          const brands = new Set(data.map(p => p.brand));
          document.getElementById('totalBrands').textContent = brands.size;
        })
        .catch(error => console.error('Error al actualizar stats:', error));
    }, 500);
  }
</script>