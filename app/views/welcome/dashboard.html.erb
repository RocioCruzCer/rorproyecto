<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>
      <i class="fas fa-database" style="color: var(--rosa-clarito);"></i> 
      Interacci√≥n con Base de Datos
    </h1>
    <p>Registra y visualiza interacciones en tiempo real</p>
  </div>
  
  <!-- Tarjeta de Estad√≠sticas - Solo Clicks -->
  <div class="stats-card">
    <div class="stats-header">
      <h2>
        <i class="fas fa-chart-bar" style="color: var(--rosa-clarito);"></i> 
        Estad√≠sticas
      </h2>
      <div class="last-updated">
        <i class="fas fa-sync-alt" style="color: var(--rosa-clarito);"></i> 
        Actualizado en tiempo real
      </div>
    </div>
    
    <div class="counter-display">
      <div class="counter-label">
        <i class="fas fa-mouse-pointer" style="color: var(--rosa-clarito);"></i> 
        Total de Registros
      </div>
      <div class="counter-value" id="clickCount">
        <%= @total_clicks || 0 %>
      </div>
      <div class="counter-subtitle">
        Interacciones registradas en la base de datos
      </div>
    </div>
  </div>
  
  <!-- Tarjeta de Registro con reCAPTCHA -->
  <div class="interaction-card">
    <div class="card-header">
      <h2>
        <i class="fas fa-plus-circle" style="color: var(--rosa-clarito);"></i> 
        Nuevo Registro
      </h2>
    </div>
    
    <div class="recaptcha-section">
      <div class="section-header">
        <i class="fas fa-shield-alt" style="color: var(--rosa-clarito);"></i> 
        Verificaci√≥n de Seguridad
      </div>
      <p class="section-description">
        Por favor, verifica que no eres un robot para habilitar el registro de interacciones.
      </p>
      
      <div class="recaptcha-container" id="recaptcha-container"></div>
      
      <div class="recaptcha-info">
        <i class="fas fa-info-circle" style="color: var(--rosa-clarito);"></i> 
        Esta verificaci√≥n ayuda a prevenir registros automatizados.
      </div>
    </div>
    
    <div class="actions-section">
      <button id="clickButton" class="action-button primary" disabled>
        <span class="button-icon"><i class="fas fa-plus"></i></span>
        <span class="button-text" id="buttonText">
          Verifica tu identidad primero
        </span>
      </button>
      
      <button id="refreshButton" class="action-button secondary" onclick="updateCounter()">
        <span class="button-icon"><i class="fas fa-sync-alt"></i></span>
        <span class="button-text">Actualizar</span>
      </button>
    </div>
    
    <div id="message" class="message-container"></div>
  </div>
</div>

<style>
  /* ===== PALETA DE COLORES COMPLETA ===== */
  :root {
    /* VERDES */
    --verde-primario: #00A86B;
    --verde-bosque: #2E8B57;
    --verde-suave: #6F8F7A;
    --verde-neon: #00C853;
    --verde-oscuro: #008F4C;
    --verde-profundo: #0B5D3B;
    --verde-intermedio: #1A7D55;
    
    /* ROSAS */
    --rosa-clarito: #FFB6C1;
    --rosa-suave: #FFC0CB;
    --rosa-palo: #FFE4E1;
    --rosa-glow: #FFD9E6;
    --rosa-muy-palido: #FFF0F5;
    
    /* NEUTROS */
    --casi-negro: #2F2F2A;
    --gris-medio: #5C5C55;
    --verde-muy-claro: #F0F7F3;
    --blanco: #FFFFFF;
    --verde-palido: #E8F3E9;
    
    /* SOMBRAS */
    --sombra-rosa-claro: rgba(255, 182, 193, 0.3);
    --sombra-rosa-semtransparente: rgba(255, 182, 193, 0.5);
    --sombra-verde-transparente: rgba(11, 93, 59, 0.2);
    
    /* VARIABLES DE APLICACI√ìN */
    --primary-dark: var(--verde-profundo);
    --primary-base: var(--verde-primario);
    --primary-light: var(--verde-suave);
    --accent-pink: var(--rosa-clarito);
    --bg-light: var(--verde-muy-claro);
    --bg-secondary: var(--verde-palido);
    --bg-pink-soft: var(--rosa-muy-palido);
    --text-dark: var(--casi-negro);
    --text-soft: var(--gris-medio);
    --border-light: rgba(11, 93, 59, 0.08);
    --border-pink-light: rgba(255, 182, 193, 0.3);
    --shadow-sm: 0 2px 8px var(--sombra-verde-transparente);
    --shadow-md: 0 4px 16px rgba(11, 93, 59, 0.08);
    --shadow-pink-sm: 0 2px 8px var(--sombra-rosa-claro);
    --shadow-pink-md: 0 4px 16px var(--sombra-rosa-semtransparente);
  }

  /* ===== CONTENEDOR PRINCIPAL √öNICO ===== */
  .dashboard-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 24px 32px;
    width: 100%;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  
  .dashboard-header {
    text-align: center;
    margin-bottom: 8px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-pink-light);
  }
  
  .dashboard-header h1 {
    color: var(--primary-dark);
    font-size: 28px;
    font-weight: 600;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    letter-spacing: -0.02em;
  }
  
  .dashboard-header h1 i {
    font-size: 24px;
  }
  
  .dashboard-header p {
    color: var(--text-soft);
    font-size: 15px;
    font-weight: 400;
    margin: 0;
  }
  
  /* ===== TARJETAS ===== */
  .stats-card, .interaction-card {
    background-color: var(--blanco);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-pink-light);
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    width: 100%;
    box-sizing: border-box;
  }
  
  .stats-card:hover, .interaction-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-pink-md);
    border-color: var(--rosa-clarito);
  }
  
  /* ===== TARJETA DE ESTAD√çSTICAS ===== */
  .stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-pink-light);
  }
  
  .stats-header h2 {
    color: var(--text-dark);
    font-size: 20px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
  }
  
  .stats-header h2 i {
    font-size: 18px;
  }
  
  .last-updated {
    background-color: var(--bg-pink-soft);
    color: var(--text-soft);
    padding: 6px 12px;
    border-radius: 30px;
    font-size: 13px;
    font-weight: 400;
    display: flex;
    align-items: center;
    gap: 6px;
    border: 1px solid var(--border-pink-light);
    white-space: nowrap;
  }
  
  .last-updated i {
    font-size: 12px;
  }
  
  .counter-display {
    text-align: center;
    padding: 24px 16px;
    background: linear-gradient(135deg, var(--bg-pink-soft) 0%, var(--blanco) 100%);
    border-radius: 12px;
    border: 1px solid var(--border-pink-light);
    position: relative;
    overflow: hidden;
  }
  
  .counter-display::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--rosa-clarito), var(--verde-primario), var(--rosa-clarito));
    animation: gradientMove 3s ease infinite;
    background-size: 200% 100%;
  }
  
  @keyframes gradientMove {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  
  .counter-label {
    color: var(--text-soft);
    font-size: 15px;
    font-weight: 500;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .counter-label i {
    font-size: 16px;
  }
  
  .counter-value {
    color: var(--primary-dark);
    font-size: 56px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    margin-bottom: 6px;
    line-height: 1.1;
    text-shadow: 1px 1px 3px var(--sombra-verde-transparente);
    background: linear-gradient(135deg, var(--primary-dark), var(--verde-primario));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .counter-subtitle {
    color: var(--text-soft);
    font-size: 14px;
    font-weight: 400;
  }
  
  /* ===== TARJETA DE INTERACCI√ìN ===== */
  .card-header {
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-pink-light);
  }
  
  .card-header h2 {
    color: var(--text-dark);
    font-size: 20px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
  }
  
  .card-header h2 i {
    font-size: 18px;
  }
  
  .recaptcha-section {
    background-color: var(--bg-pink-soft);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid var(--border-pink-light);
  }
  
  .section-header {
    color: var(--primary-dark);
    font-size: 17px;
    font-weight: 500;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .section-header i {
    font-size: 16px;
  }
  
  .section-description {
    color: var(--text-soft);
    font-size: 14px;
    margin-bottom: 16px;
    line-height: 1.5;
  }
  
  .recaptcha-container {
    display: flex;
    justify-content: center;
    margin: 16px 0;
    min-height: 74px;
    background-color: var(--blanco);
    border-radius: 6px;
    padding: 8px;
    border: 1px solid var(--border-pink-light);
  }
  
  .recaptcha-info {
    background-color: var(--blanco);
    color: var(--text-dark);
    padding: 12px;
    border-radius: 8px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
    border-left: 3px solid var(--rosa-clarito);
    border: 1px solid var(--border-pink-light);
  }
  
  .recaptcha-info i {
    font-size: 14px;
  }
  
  .actions-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
  }
  
  .action-button {
    padding: 14px 20px;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
  }
  
  .action-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-pink-sm);
  }
  
  .action-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }
  
  .action-button .button-icon i {
    font-size: 14px;
  }
  
  .action-button.primary {
    background: linear-gradient(135deg, var(--rosa-clarito) 0%, var(--rosa-suave) 100%);
    color: var(--text-dark);
  }
  
  .action-button.primary:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--rosa-suave) 0%, var(--rosa-clarito) 100%);
    box-shadow: 0 6px 16px var(--sombra-rosa-semtransparente);
  }
  
  .action-button.secondary {
    background-color: var(--verde-muy-claro);
    color: var(--primary-dark);
    border: 1px solid var(--border-pink-light);
  }
  
  .action-button.secondary:hover:not(:disabled) {
    background-color: var(--bg-pink-soft);
    border-color: var(--rosa-clarito);
  }
  
  .message-container {
    min-height: 48px;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 400;
    display: none;
    align-items: center;
    border: 1px solid transparent;
    transition: all 0.2s ease;
  }
  
  .message-container.show {
    display: flex;
  }
  
  .message-container.info {
    background-color: var(--bg-pink-soft);
    color: var(--text-dark);
    border-color: var(--rosa-clarito);
  }
  
  .message-container.success {
    background-color: rgba(0, 168, 107, 0.08);
    color: var(--verde-primario);
    border-color: var(--verde-primario);
  }
  
  .message-container.error {
    background-color: rgba(255, 182, 193, 0.15);
    color: #D44A5E;
    border-color: var(--rosa-clarito);
  }
  
  /* ===== ANIMACIONES ===== */
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.03); }
    100% { transform: scale(1); }
  }
  
  .counter-updated {
    animation: pulse 0.4s ease;
  }
  
  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .dashboard-container {
      padding: 16px 20px;
      gap: 20px;
    }
    
    .dashboard-header h1 {
      font-size: 24px;
      gap: 10px;
    }
    
    .dashboard-header h1 i {
      font-size: 22px;
    }
    
    .dashboard-header p {
      font-size: 14px;
    }
    
    .counter-value {
      font-size: 48px;
    }
    
    .stats-header {
      flex-direction: column;
      gap: 12px;
      text-align: center;
      align-items: center;
    }
    
    .stats-header h2 {
      font-size: 18px;
    }
    
    .last-updated {
      font-size: 12px;
      padding: 5px 10px;
    }
    
    .action-button {
      padding: 12px 16px;
      font-size: 14px;
    }
    
    .actions-section {
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .stats-card, .interaction-card {
      padding: 20px;
    }
    
    .recaptcha-section {
      padding: 16px;
    }
  }
  
  @media (max-width: 480px) {
    .dashboard-container {
      padding: 12px 16px;
      gap: 16px;
    }
    
    .dashboard-header h1 {
      font-size: 20px;
      flex-direction: column;
      gap: 8px;
    }
    
    .dashboard-header h1 i {
      font-size: 20px;
    }
    
    .counter-value {
      font-size: 40px;
    }
    
    .counter-label {
      font-size: 14px;
    }
    
    .counter-subtitle {
      font-size: 13px;
    }
    
    .stats-card, .interaction-card {
      padding: 16px;
    }
    
    .card-header h2 {
      font-size: 18px;
    }
    
    .section-header {
      font-size: 16px;
    }
    
    .section-description {
      font-size: 13px;
    }
    
    .recaptcha-info {
      font-size: 12px;
      padding: 10px;
    }
    
    .recaptcha-container {
      transform: scale(0.95);
      margin: 8px 0;
    }
  }
  
  @media (max-width: 400px) {
    .recaptcha-container {
      transform: scale(0.9);
      margin: 4px 0;
    }
  }
</style>

<!-- reCAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script>
  // ============ CONFIGURACI√ìN ============
  const clickButton = document.getElementById('clickButton');
  const refreshButton = document.getElementById('refreshButton');
  const buttonText = document.getElementById('buttonText');
  const clickCount = document.getElementById('clickCount');
  const messageDiv = document.getElementById('message');
  const lastInteractionElement = document.getElementById('lastInteraction');
  
  let isProcessing = false;
  let recaptchaVerified = false;
  let recaptchaWidgetId = null;
  
  // ============ FUNCIONES ============
  
  function showMessage(text, type = 'info') {
    messageDiv.textContent = text;
    messageDiv.className = 'message-container show';
    messageDiv.classList.add(type);
    
    if (type === 'success') {
      setTimeout(() => {
        messageDiv.textContent = '';
        messageDiv.className = 'message-container';
      }, 3000);
    }
  }
  
  function updateCounter() {
    fetch('/clicks/total')
      .then(response => response.json())
      .then(data => {
        const newCount = data.total;
        clickCount.textContent = newCount;
        
        clickCount.classList.add('counter-updated');
        
        const now = new Date();
        if (lastInteractionElement) {
          lastInteractionElement.textContent = now.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
        }
        
        setTimeout(() => {
          clickCount.classList.remove('counter-updated');
        }, 400);
      })
      .catch(error => {
        console.error('Error al actualizar contador:', error);
      });
  }
  
  // ============ FUNCIONES DE reCAPTCHA ============
  
  function onRecaptchaSuccess() {
    recaptchaVerified = true;
    clickButton.disabled = false;
    buttonText.textContent = 'Registrar Nueva Interacci√≥n';
    showMessage('‚úÖ Verificaci√≥n completada', 'success');
  }
  
  function onRecaptchaExpired() {
    recaptchaVerified = false;
    clickButton.disabled = true;
    buttonText.textContent = 'Verifica reCAPTCHA primero';
    showMessage('‚è≥ La verificaci√≥n ha expirado', 'error');
  }
  
  function loadRecaptcha() {
    const container = document.getElementById('recaptcha-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (typeof grecaptcha !== 'undefined') {
      try {
        recaptchaWidgetId = grecaptcha.render('recaptcha-container', {
          'sitekey': '6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI',
          'callback': onRecaptchaSuccess,
          'expired-callback': onRecaptchaExpired,
          'theme': 'light'
        });
        console.log('‚úÖ reCAPTCHA cargado');
      } catch (error) {
        console.error('Error al cargar reCAPTCHA:', error);
        container.innerHTML = '<div style="color: var(--rosa-clarito); font-size: 14px;">Error al cargar reCAPTCHA. Recarga la p√°gina.</div>';
      }
    } else {
      setTimeout(loadRecaptcha, 200);
    }
  }
  
  // ============ MANEJADOR DE CLICK ============
  
  async function handleClick() {
    if (!recaptchaVerified || isProcessing) return;
    
    isProcessing = true;
    clickButton.disabled = true;
    showMessage('‚è≥ Procesando registro...', 'info');
    
    try {
      const token = grecaptcha.getResponse(recaptchaWidgetId);
      
      if (!token) {
        throw new Error('Token no disponible');
      }
      
      const response = await fetch('/clicks/increment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
        },
        body: JSON.stringify({ 'g-recaptcha-response': token })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showMessage('‚úÖ ' + data.message, 'success');
        updateCounter();
        grecaptcha.reset(recaptchaWidgetId);
        recaptchaVerified = false;
        buttonText.textContent = 'Verifica reCAPTCHA primero';
      } else {
        showMessage('‚ùå ' + (data.error || 'Error en el servidor'), 'error');
        grecaptcha.reset(recaptchaWidgetId);
      }
    } catch (error) {
      console.error('Error:', error);
      showMessage('‚ùå Error de conexi√≥n', 'error');
      grecaptcha.reset(recaptchaWidgetId);
    } finally {
      isProcessing = false;
    }
  }
  
  // ============ INICIALIZACI√ìN ============
  
  document.addEventListener('DOMContentLoaded', function() {
    loadRecaptcha();
    updateCounter();
    
    if (clickButton) clickButton.addEventListener('click', handleClick);
    if (refreshButton) refreshButton.addEventListener('click', updateCounter);
    
    // Actualizar cada 30 segundos
    setInterval(updateCounter, 30000);
    
    // Mensaje de bienvenida
    setTimeout(() => {
      if (!recaptchaVerified) {
        showMessage('üëã Completa la verificaci√≥n reCAPTCHA', 'info');
      }
    }, 1500);
    
    // Atajo de teclado Enter
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !isProcessing && recaptchaVerified && !event.target.matches('button, input, textarea, a')) {
        handleClick();
      }
    });
    
    // Actualizar breadcrumb si existe la funci√≥n
    if (typeof updateBreadcrumb === 'function') {
      updateBreadcrumb('Interacci√≥n con Base de Datos', 'fa-database');
    }
  });
</script>