<div class="dashboard-container">
  <div class="dashboard-header">
    <h1><i class="fas fa-database"></i> Interacci√≥n con Base de Datos</h1>
    <p>Registra y visualiza interacciones en tiempo real</p>
  </div>
  
  <div class="dashboard-content">
    <div class="stats-card">
      <div class="stats-header">
        <h2><i class="fas fa-chart-bar"></i> Estad√≠sticas</h2>
        <div class="last-updated">
          <i class="fas fa-sync-alt"></i> Actualizado en tiempo real
        </div>
      </div>
      
      <div class="counter-display">
        <div class="counter-label">
          <i class="fas fa-mouse-pointer"></i> Total de Registros
        </div>
        <div class="counter-value" id="clickCount">
          <%= @total_clicks %>
        </div>
        <div class="counter-subtitle">
          Interacciones registradas en la base de datos
        </div>
      </div>
    </div>
    
    <div class="interaction-card">
      <div class="card-header">
        <h2><i class="fas fa-plus-circle"></i> Nuevo Registro</h2>
      </div>
      
      <div class="recaptcha-section">
        <div class="section-header">
          <i class="fas fa-shield-alt"></i> Verificaci√≥n de Seguridad
        </div>
        <p class="section-description">
          Por favor, verifica que no eres un robot para habilitar el registro de interacciones.
        </p>
        
        <div class="recaptcha-container">
          <div class="g-recaptcha" 
               data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"
               data-callback="onRecaptchaSuccess"
               data-expired-callback="onRecaptchaExpired"
               data-error-callback="onRecaptchaError">
          </div>
        </div>
        
        <div class="recaptcha-info">
          <i class="fas fa-info-circle"></i> Esta verificaci√≥n ayuda a prevenir registros automatizados.
        </div>
      </div>
      
      <div class="actions-section">
        <button id="clickButton" class="action-button primary" disabled>
          <span class="button-icon"><i class="fas fa-plus"></i></span>
          <span class="button-text" id="buttonText">
            Verifica tu identidad primero
          </span>
        </button>
      </div>
      
      <div id="message" class="message-container"></div>
    </div>
    
    <div class="info-card">
      <h3><i class="fas fa-info-circle"></i> Informaci√≥n de Sesi√≥n</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">ID de Sesi√≥n</div>
          <div class="info-value">
            <i class="fas fa-fingerprint"></i>
            <span id="sessionId"><%= SecureRandom.hex(8).upcase %></span>
          </div>
        </div>
        <div class="info-item">
          <div class="info-label">√öltimo Registro</div>
          <div class="info-value">
            <i class="fas fa-clock"></i>
            <span id="lastInteraction">N/A</span>
          </div>
        </div>
        <div class="info-item">
          <div class="info-label">Estado</div>
          <div class="info-value connected">
            <i class="fas fa-check-circle"></i> Activo
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .dashboard-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .dashboard-header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 25px;
    border-bottom: 2px solid #E4DDC9;
  }
  
  .dashboard-header h1 {
    color: #0B5D3B;
    font-size: 36px;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
  }
  
  .dashboard-header p {
    color: #6F8F7A;
    font-size: 18px;
    font-weight: 500;
  }
  
  .dashboard-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
  }
  
  .stats-card, .interaction-card, .info-card {
    background-color: #FFFFFF;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 40px rgba(11, 93, 59, 0.08);
    border: 1px solid #E4DDC9;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .stats-card:hover, .interaction-card:hover, .info-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 50px rgba(11, 93, 59, 0.12);
  }
  
  .stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #E4DDC9;
  }
  
  .stats-header h2 {
    color: #2F2F2A;
    font-size: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .stats-header h2 i {
    color: #0B5D3B;
  }
  
  .last-updated {
    background-color: #E4DDC9;
    color: #6F8F7A;
    padding: 8px 16px;
    border-radius: 50px;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .counter-display {
    text-align: center;
    padding: 40px 20px;
    background: linear-gradient(135deg, #FAF5E9 0%, #FFFFFF 100%);
    border-radius: 16px;
    border: 2px solid #E4DDC9;
  }
  
  .counter-label {
    color: #6F8F7A;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  
  .counter-value {
    color: #0B5D3B;
    font-size: 72px;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    margin-bottom: 10px;
    line-height: 1;
    text-shadow: 2px 2px 4px rgba(11, 93, 59, 0.1);
  }
  
  .counter-subtitle {
    color: #6F8F7A;
    font-size: 16px;
    font-weight: 500;
  }
  
  .card-header {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #E4DDC9;
  }
  
  .card-header h2 {
    color: #2F2F2A;
    font-size: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .card-header h2 i {
    color: #E0B100;
  }
  
  .recaptcha-section {
    background-color: #FAF5E9;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 30px;
    border: 1px solid #E4DDC9;
  }
  
  .section-header {
    color: #0B5D3B;
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .section-description {
    color: #6F8F7A;
    font-size: 15px;
    margin-bottom: 20px;
    line-height: 1.6;
  }
  
  .recaptcha-container {
    display: flex;
    justify-content: center;
    margin: 25px 0;
  }
  
  .recaptcha-info {
    background-color: #E4DDC9;
    color: #2F2F2A;
    padding: 15px;
    border-radius: 12px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-left: 4px solid #6F8F7A;
  }
  
  .recaptcha-info i {
    color: #6F8F7A;
  }
  
  .actions-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .action-button {
    padding: 20px 30px;
    border: none;
    border-radius: 16px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    width: 100%;
  }
  
  .action-button:hover:not(:disabled) {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  }
  
  .action-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }
  
  .action-button.primary {
    background: linear-gradient(135deg, #E0B100 0%, #F0C900 100%);
    color: #2F2F2A;
  }
  
  .action-button.primary:hover:not(:disabled) {
    background: linear-gradient(135deg, #F0C900 0%, #E0B100 100%);
    box-shadow: 0 10px 25px rgba(224, 177, 0, 0.3);
  }
  
  .action-button.secondary {
    background-color: #6F8F7A;
    color: #FAF5E9;
  }
  
  .action-button.secondary:hover:not(:disabled) {
    background-color: #5A7F66;
    box-shadow: 0 10px 25px rgba(111, 143, 122, 0.3);
  }
  
  .button-icon {
    font-size: 20px;
  }
  
  .message-container {
    min-height: 60px;
    padding: 20px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 500;
    display: flex;
    align-items: center;
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }
  
  .message-container:empty {
    display: none;
  }
  
  .message-container.info {
    background-color: #E4DDC9;
    color: #2F2F2A;
    border-color: #6F8F7A;
  }
  
  .message-container.success {
    background-color: rgba(11, 93, 59, 0.1);
    color: #0B5D3B;
    border-color: #0B5D3B;
  }
  
  .message-container.error {
    background-color: rgba(224, 177, 0, 0.1);
    color: #B38F00;
    border-color: #E0B100;
  }
  
  .info-card h3 {
    color: #2F2F2A;
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .info-card h3 i {
    color: #6F8F7A;
  }
  
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }
  
  .info-item {
    background-color: #FAF5E9;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #E4DDC9;
  }
  
  .info-label {
    color: #6F8F7A;
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }
  
  .info-value {
    color: #2F2F2A;
    font-size: 16px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .info-value.connected i {
    color: #0B5D3B;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  .counter-updated {
    animation: pulse 0.5s ease;
  }
  
  @media (max-width: 768px) {
    .dashboard-header h1 {
      font-size: 28px;
      flex-direction: column;
      gap: 10px;
    }
    
    .counter-value {
      font-size: 56px;
    }
    
    .stats-header {
      flex-direction: column;
      gap: 15px;
      text-align: center;
    }
    
    .action-button {
      padding: 18px 25px;
      font-size: 16px;
    }
    
    .info-grid {
      grid-template-columns: 1fr;
    }
    
    .actions-section {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 480px) {
    .counter-value {
      font-size: 48px;
    }
    
    .stats-card, .interaction-card, .info-card {
      padding: 20px;
    }
    
    .dashboard-header h1 {
      font-size: 24px;
    }
    
    .dashboard-header p {
      font-size: 16px;
    }
  }
</style>

<script>
  // ============ CONFIGURACI√ìN INICIAL ============
  const clickButton = document.getElementById('clickButton');
  const buttonText = document.getElementById('buttonText');
  const clickCount = document.getElementById('clickCount');
  const messageDiv = document.getElementById('message');
  const sessionIdElement = document.getElementById('sessionId');
  const lastInteractionElement = document.getElementById('lastInteraction');
  
  let isProcessing = false;
  let recaptchaVerified = false;
  
  // ============ FUNCIONES DE UTILIDAD ============
  
  function showMessage(text, type = 'info') {
    messageDiv.textContent = text;
    messageDiv.className = 'message-container';
    
    if (text) {
      messageDiv.classList.add(type);
    }
    
    if (type === 'success') {
      setTimeout(() => {
        if (messageDiv.textContent === text) {
          messageDiv.textContent = '';
          messageDiv.className = 'message-container';
        }
      }, 4000);
    }
  }
  
  function updateCounter() {
    fetch('/clicks/total')
      .then(response => response.json())
      .then(data => {
        clickCount.textContent = data.total;
        clickCount.classList.add('counter-updated');
        
        // Actualizar √∫ltima interacci√≥n
        const now = new Date();
        lastInteractionElement.textContent = now.toLocaleTimeString('es-ES', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        setTimeout(() => {
          clickCount.classList.remove('counter-updated');
        }, 500);
      })
      .catch(error => {
        console.error('Error al actualizar contador:', error);
      });
  }
  
  // ============ FUNCIONES DE reCAPTCHA ============
  
  function onRecaptchaSuccess(response) {
    recaptchaVerified = true;
    
    clickButton.disabled = false;
    buttonText.textContent = 'Registrar Nueva Interacci√≥n';
    
    showMessage('‚úÖ Verificaci√≥n completada. Ahora puedes registrar interacciones.', 'success');
  }
  
  function onRecaptchaExpired() {
    recaptchaVerified = false;
    
    clickButton.disabled = true;
    buttonText.textContent = 'Verifica reCAPTCHA primero';
    
    showMessage('‚è≥ La verificaci√≥n ha expirado. Por favor, verifica nuevamente.', 'error');
  }
  
  function onRecaptchaError() {
    showMessage('‚ùå Error en la verificaci√≥n. Por favor, recarga la p√°gina.', 'error');
  }
  
  // ============ MANEJADORES DE EVENTOS ============
  
  async function handleClick() {
    if (!recaptchaVerified) {
      showMessage('‚ö†Ô∏è Por favor, completa la verificaci√≥n reCAPTCHA primero.', 'error');
      return;
    }
    
    if (isProcessing) return;
    
    isProcessing = true;
    showMessage('‚è≥ Procesando registro...', 'info');
    clickButton.disabled = true;
    
    try {
      const recaptchaResponse = grecaptcha.getResponse();
      
      if (!recaptchaResponse) {
        throw new Error('Token de reCAPTCHA no disponible');
      }
      
      const response = await fetch('/clicks/increment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          'g-recaptcha-response': recaptchaResponse
        })
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Error en el servidor');
      }
      
      if (data.success) {
        clickCount.textContent = data.total;
        showMessage('‚úÖ ' + data.message, 'success');
        
        // Actualizar √∫ltima interacci√≥n
        const now = new Date();
        lastInteractionElement.textContent = now.toLocaleTimeString('es-ES', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        grecaptcha.reset();
        recaptchaVerified = false;
        clickButton.disabled = true;
        buttonText.textContent = 'Verifica reCAPTCHA primero';
      } else {
        showMessage('‚ùå ' + (data.error || 'Error al procesar la solicitud'), 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showMessage('‚ùå Error de conexi√≥n. Intenta nuevamente.', 'error');
    } finally {
      isProcessing = false;
      if (recaptchaVerified) {
        clickButton.disabled = false;
      }
    }
  }
  
  // ============ INICIALIZACI√ìN ============
  
  function initialize() {
    clickButton.addEventListener('click', handleClick);
    
    // Generar ID de sesi√≥n si no existe
    if (sessionIdElement && !sessionIdElement.textContent.trim()) {
      sessionIdElement.textContent = 'SES-' + Math.random().toString(36).substr(2, 9).toUpperCase();
    }
    
    updateCounter();
    setInterval(updateCounter, 10000);
    
    setTimeout(() => {
      showMessage('üëã Completa la verificaci√≥n reCAPTCHA para habilitar el registro.', 'info');
    }, 1500);
    
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !isProcessing && recaptchaVerified) {
        handleClick();
      }
    });
    
    // Actualizar breadcrumb espec√≠fico para esta p√°gina
    updateBreadcrumb('Interacci√≥n con Base de Datos', 'fa-database');
  }
  
  function checkRecaptchaLoaded() {
    if (typeof grecaptcha !== 'undefined') {
      initialize();
    } else {
      setTimeout(checkRecaptchaLoaded, 100);
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkRecaptchaLoaded);
  } else {
    checkRecaptchaLoaded();
  }
</script>